<script>
    $(function() {
        var matterTemplate = _.template(
            '<h4><%= MatterTitle %></h4>'
        );

        var resultTemplate = _.template(
              '<div class="result" id="<%= id %>">'
            + '  <a href="<%= canonical_url %>"><img src="<%= resources.thumbnail %>" /></a>'
            + '  <div><%= description %></div>'
            + '  <div>'
            + '    <a href="<%= resources.published_url %>">Read</a>'
            + '    &nbsp;<a href="<%= source %>">Download PDF</a>'
            + '  </div>'
            + '</div>'
        )

        var addResult = function(obj) {
            $(matterTemplate(obj.data)).appendTo('#search-results');
    
            $.each(obj.docs, function(i, doc) {
                $(resultTemplate(doc)).appendTo('#search-results');
            });
        };

        $('input[type=submit]').click(function() {
            var q = $('input[type=text]').val();
            q = q + ' account:12872-knight-lab';
            $.ajax({
                url: 'https://www.documentcloud.org/api/search.json?q=' + q + '&per_page=1000&data=true'
            }).success(function(data) {
                var groups = {};
    
                $.each(data.documents, function(i, doc) {
                    if(doc.data.MatterId in groups) {
                        groups[doc.data.MatterId][docs].push(doc);
                    } else {
                        groups[doc.data.MatterId] = {
                            'data': doc.data,
                            'docs': [doc]
                        };
                    }
                });
    
                $.each(groups, function(i, g) {
                    addResult(g);
                });
            });
        });

        $('.example-search').click(function() {
              console.log($(this).text());
              $('#search-input').val($(this).text());
              $('#search-submit').click();
              return false;
        });
    });
</script>
