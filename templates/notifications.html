{% extends "base.html" %}

{% block content %}

{% if error %}

<div data-alert class="alert-box alert">
    Error managing notifications [{{ error }}]
</div>

{% else %}

<div id="notifications-alert" data-alert class="alert-box alert" style="display: none;">
  <span></span>
  <a href="#" class="close">&times;</a>  
</div>

<div id="notifications-alert-empty" data-alert class="alert-box info" style="display: none;">
    No subscriptions found.
</div>

<div id="notifications-list" class="row">
    <div class="medium-12 columns">
        <div class="row">
            <p>Managing notifications for {{ email }}</p>
        </div>   
        <div class="row">
            <div class="medium-6 columns">
                Your watched searches
            </div>
            <div class="medium-6 columns">
                Email when results change?
            </div>
        </div>
        {% for r in subscriptions %}
        <div class="row">
            <div class="medium-6 columns">
                &ldquo;{{ r.query }}&rdquo;
            </div>
            <div class="medium-6 columns">
                <input id="notifications-checkbox-{{ r.sid }}" type="checkbox" value="1" data-sid="{{ r.sid }}" checked>
                <label for="notifications-checkbox-{{ r.sid }}">Notify me</label>
            </div>
        </div>
        {% endfor %}           
        <div class="row">
            <div class="medium-6 medium-offset-6 columns">
                <button type="submit" value="Save" id="notifications-save" class="button alert">Save</button>
            </div>
        </div>        
    </div>
</div>

{% endif %}

{% endblock content %}

{% block extra_scripts %}

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>
<script type="text/javascript" src="//cdn.knightlab.com/libs/purpleline/latest/js/foundation.alert.js"></script>
<script type="text/javascript">

function notifications_alert(error, detail) {
    $('#notifications-alert > span').html(error + (detail ? ' ['+detail+']' : ''));
    $('#notifications-alert').show();
}

$(function() {
    $(document).foundation();
    
    $('#notifications-save').click(function(event) {
        var sids = [];
        var $checkboxes = $("input[type=checkbox]:not(:checked)")
            .each(function(index, el) {
                sids.push($(el).attr('data-sid'));
            });
                
        if(sids.length) {
            $('#notifications-save').prop('disabled', true);
                       
            $.ajax({
                url: '{% url "unsubscribe" %}',
                type: 'GET',
                data: {
                    sids: sids
                },
                cache: false,
                dataType: 'json',
                timeout: 20000,
                error: function(xhr, status, err) {
                    notifications_alert('Error saving changes to notifications', err);
                },
                success: function(data) {
                    if(data.error) {
                        notifications_alert('Error saving changes to notifications', data.error);
                    } else {               
                        $('#notifications-alert').hide();
                             
                        $checkboxes.closest('div.row').remove();                            

                        if(!$("input[type=checkbox]").length) {
                            $('#notifications-alert-empty').show();
                            $('#notifications-list').hide();
                        }
                    }
                },
                complete: function() {
                    $('#notifications-save').prop('disabled', false);                
                }
            });       
        }  
    });
});

</script>

{% endblock %}